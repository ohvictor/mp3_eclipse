
#include "EQ_FIR.h"
#include "arm_math.h"
#include "math_helper.h"

#define TAPS    70
#define BLOCK_SIZE  32

static uint8_t selected_eq = NO_EQ;

static float32_t filter_state[NUM_FILTERS][TAPS+BLOCK_SIZE-1];      

static arm_fir_instance_f32 filter_instance[NUM_FILTERS];       

static uint32_t eqFrameSize;
static float32_t output[TAPS];

static const float32_t bass_filter[TAPS] __attribute__((aligned(32))) = {-0.0005623900958023f, -0.0004585531282601f, -0.0003581228848981f, -0.0002429394241331f, 
                                                                        -0.0000936608988687f, 0.0001096987353213f, 0.0003871957219533f, 0.0007583613209713f, 
                                                                        0.0012416014353831f, 0.0018536074943696f, 0.0026087950402085f, 0.0035187860073312f, 
                                                                        0.0045919497707671f, 0.0058330166981958f, 0.0072427761974298f, 0.0088178691536297f, 
                                                                        0.0105506822526590f, 0.0124293490524952f, 0.0144378598645229f, 0.0165562796171790f, 
                                                                        0.0187610699752190f, 0.0210255091591889f, 0.0233202002304638f, 0.0256136561527773f, 
                                                                        0.0278729477810049f, 0.0300643991237918f, 0.0321543128304971f, 0.0341097079058343f, 
                                                                        0.0358990511861225f, 0.0374929641346436f, 0.0388648870319437f, 0.0399916836379593f, 
                                                                        0.0408541708610412f, 0.0414375598459314f, 0.0417317971384347f, 0.0417317971384347f, 
                                                                        0.0414375598459314f, 0.0408541708610412f, 0.0399916836379593f, 0.0388648870319437f, 
                                                                        0.0374929641346436f, 0.0358990511861225f, 0.0341097079058343f, 0.0321543128304971f, 
                                                                        0.0300643991237918f, 0.0278729477810049f, 0.0256136561527773f, 0.0233202002304638f, 
                                                                        0.0210255091591889f, 0.0187610699752191f, 0.0165562796171790f, 0.0144378598645229f, 
                                                                        0.0124293490524952f, 0.0105506822526590f, 0.0088178691536297f, 0.0072427761974298f, 
                                                                        0.0058330166981958f, 0.0045919497707671f, 0.0035187860073312f, 0.0026087950402085f, 
                                                                        0.0018536074943696f, 0.0012416014353831f, 0.0007583613209713f, 0.0003871957219533f, 
                                                                        0.0001096987353213f, -0.0000936608988687f, -0.0002429394241331f, -0.0003581228848981f, 
                                                                        -0.0004585531282601f, -0.0005623900958023f};

static const float32_t low_mid_filter[TAPS] __attribute__((aligned(32))) = {-0.0001077828712415f, -0.0002516283214218f, -0.0004627274361062f, -0.0007695847037376f, 
                                                                        -0.0012059592917887f, -0.0018068004438439f, -0.0026033097547284f, -0.0036175443269291f, 
                                                                        -0.0048570492697101f, -0.0063100433073133f, -0.0079416726351452f, -0.0096917943660476f, 
                                                                        -0.0114746544563903f, -0.0131806920592919f, -0.0146805422329397f, -0.0158311338144453f, 
                                                                        -0.0164836026885733f, -0.0164925768598092f, -0.0157262523489747f, -0.0140765799845175f, 
                                                                        -0.0114688319657542f, -0.0078698194676012f, -0.0032940903149999f, 0.0021924536208321f, 
                                                                        0.0084719228460994f, 0.0153770014713354f, 0.0226966993502378f, 0.0301850695018746f, 
                                                                        0.0375724528939899f, 0.0445786257267882f, 0.0509270770579257f, 0.0563595484866880f, 
                                                                        0.0606499305379882f, 0.0636166359153425f, 0.0651326568645250f, 0.0651326568645250f,
                                                                        0.0636166359153425f, 0.0606499305379882f, 0.0563595484866880f, 0.0509270770579257f, 
                                                                        0.0445786257267882f, 0.0375724528939899f, 0.0301850695018746f, 0.0226966993502378f,
                                                                        0.0153770014713354f, 0.0084719228460994f, 0.0021924536208321f, -0.0032940903149999f, 
                                                                        -0.0078698194676012f, -0.0114688319657542f, -0.0140765799845175f, -0.0157262523489747f, 
                                                                        -0.0164925768598092f, -0.0164836026885733f, -0.0158311338144454f, -0.0146805422329397f, 
                                                                        -0.0131806920592919f, -0.0114746544563904f, -0.0096917943660476f, -0.0079416726351452f, 
                                                                        -0.0063100433073133f, -0.0048570492697101f, -0.0036175443269291f, -0.0026033097547284f, 
                                                                        -0.0018068004438439f, -0.0012059592917887f, -0.0007695847037376f, -0.0004627274361062f, 
                                                                        -0.0002516283214218f, -0.0001077828712415f};

static const float32_t mid_filter[TAPS] __attribute__((aligned(32))) = {0.0014748152573846f, 0.0015420367358200f, 0.0015248326559458f, 0.0013866586956849f, 
                                                                        0.0010864159085192f, 0.0006008225261453f, -0.0000507120614191f, -0.0007882768128575f, 
                                                                        -0.0014699873983951f, -0.0019128231668812f, -0.0019359695069528f, -0.0014199228704966f, 
                                                                        -0.0003682881103642f, 0.0010446836703024f, 0.0024577858037139f, 0.0033503024723371f, 
                                                                        0.0031173011292538f, 0.0011859459731534f, -0.0028450808626546f, -0.0090696090774549f, 
                                                                        -0.0171718858588560f, -0.0263863869523532f, -0.0355386958364189f, -0.0431724966537923f, 
                                                                        -0.0477508553267180f, -0.0479036546493303f, -0.0426807738785413f, -0.0317652443265025f, 
                                                                        -0.0156038084515284f, 0.0045759663776064f, 0.0268743952538877f, 0.0489446026616366f, 
                                                                        0.0683026909371426f, 0.0826755533281935f, 0.0903302356684206f, 0.0903302356684206f, 
                                                                        0.0826755533281935f, 0.0683026909371426f, 0.0489446026616366f, 0.0268743952538877f, 
                                                                        0.0045759663776064f, -0.0156038084515284f, -0.0317652443265025f, -0.0426807738785413f, 
                                                                        -0.0479036546493303f, -0.0477508553267180f, -0.0431724966537923f, -0.0355386958364189f, 
                                                                        -0.0263863869523532f, -0.0171718858588560f, -0.0090696090774549f, -0.0028450808626546f, 
                                                                        0.0011859459731534f, 0.0031173011292538f, 0.0033503024723371f, 0.0024577858037139f, 
                                                                        0.0010446836703024f, -0.0003682881103642f, -0.0014199228704966f, -0.0019359695069528f, 
                                                                        -0.0019128231668812f, -0.0014699873983951f, -0.0007882768128575f, -0.0000507120614191f, 
                                                                        0.0006008225261453f, 0.0010864159085192f, 0.0013866586956849f, 0.0015248326559458f, 
                                                                        0.0015420367358200f, 0.0014748152573846f};

static const float32_t high_mid_filter[TAPS] __attribute__((aligned(32))) = {-0.0011221875513638f, 0.0000352081977404f, 0.0007038022232366f, 0.0000823726728481f, 
                                                                            -0.0004367641428932f, 0.0009634677275371f, 0.0031717394030765f, 0.0028981396173539f, 
                                                                            0.0000782496915949f, -0.0007875265671083f, 0.0020445045505669f, 0.0027493110962542f, 
                                                                            -0.0034405614788705f, -0.0100927318534999f, -0.0076369962308141f, -0.0003661650115920f, 
                                                                            -0.0021091032587524f, -0.0119226119579367f, -0.0106255905298479f, 0.0083600068028855f, 
                                                                            0.0222877540938023f, 0.0125723312791174f, -0.0001594042684898f, 0.0149041993134735f, 
                                                                            0.0418009327647306f, 0.0318001219154666f, -0.0165468987184617f, -0.0402171233411307f, 
                                                                            -0.0086034395925360f, 0.0075926241465494f, -0.0687614570398103f, -0.1747816715258490f, 
                                                                            -0.1453809497892109f, 0.0672546712363856f, 0.2842249989454244f, 0.2842249989454244f, 
                                                                            0.0672546712363856f, -0.1453809497892109f, -0.1747816715258490f, -0.0687614570398103f, 
                                                                            0.0075926241465494f, -0.0086034395925360f, -0.0402171233411307f, -0.0165468987184617f, 
                                                                            0.0318001219154666f, 0.0418009327647306f, 0.0149041993134735f, -0.0001594042684898f, 
                                                                            0.0125723312791174f, 0.0222877540938023f, 0.0083600068028855f, -0.0106255905298479f, 
                                                                            -0.0119226119579367f, -0.0021091032587524f, -0.0003661650115920f, -0.0076369962308141f, 
                                                                            -0.0100927318534999f, -0.0034405614788705f, 0.0027493110962542f, 0.0020445045505669f, 
                                                                            -0.0007875265671083f, 0.0000782496915949f, 0.0028981396173539f, 0.0031717394030765f, 
                                                                            0.0009634677275371f, -0.0004367641428932f, 0.0000823726728481f, 0.0007038022232366f, 
                                                                            0.0000352081977404f, -0.0011221875513638f};

static const float32_t treble_filter[TAPS] __attribute__((aligned(32))) = {-0.0012901509252937f, 0.0000411046922137f, -0.0001079425721933f, 0.0013196916251732f, 
                                                                            -0.0001936351891869f, -0.0015208452604870f, -0.0000531684914330f, 0.0003558734675631f, 
                                                                            0.0037157181160696f, -0.0038161457392444f, 0.0000454476543395f, -0.0040088891953548f, 
                                                                            0.0087826441196581f, -0.0017581156599043f, -0.0008957590118189f, -0.0087298199162627f,
                                                                            0.0042337837064703f, 0.0107747899842497f, -0.0033087390137267f, -0.0043018314946597f, 
                                                                            -0.0188662367700001f, 0.0267229281219956f, -0.0026531433781697f, 0.0143522260627427f, 
                                                                            -0.0468439324977446f, 0.0182822072486342f, 0.0104566984791723f, 0.0363122537466402f, 
                                                                            -0.0359463047444671f, -0.0551227767757623f, 0.0437140750970909f, 0.0347003570084402f,
                                                                            0.1251062304810719f, -0.3865681636016191f, 0.2361663903052270f, 0.2361663903052270f, 
                                                                            -0.3865681636016191f, 0.1251062304810719f, 0.0347003570084402f, 0.0437140750970909f, 
                                                                            -0.0551227767757623f, -0.0359463047444671f, 0.0363122537466402f, 0.0104566984791723f, 
                                                                            0.0182822072486342f, -0.0468439324977446f, 0.0143522260627427f, -0.0026531433781697f, 
                                                                            0.0267229281219956f, -0.0188662367700001f, -0.0043018314946597f, -0.0033087390137267f, 
                                                                            0.0107747899842497f, 0.0042337837064703f, -0.0087298199162627f, -0.0008957590118189f, 
                                                                            -0.0017581156599043f, 0.0087826441196581f, -0.0040088891953548f, 0.0000454476543395f, 
                                                                            -0.0038161457392444f, 0.0037157181160696f, 0.0003558734675631f, -0.0000531684914330f, 
                                                                            -0.0015208452604870f, -0.0001936351891869f, 0.0013196916251732f, -0.0001079425721933f, 
                                                                            0.0000411046922137f, -0.0012901509252937f};

static const float32_t * eqFIRCoef[NUM_FILTERS] =    
{
	bass_filter,
    low_mid_filter,    
    mid_filter,
    high_mid_filter,
    treble_filter
};

void eq_init(uint32_t frameSize)
{	
	for (uint32_t i=0; i < NUM_FILTERS; i++)
	{
		arm_fir_init_f32(&(filter_instance[i]), TAPS, eqFIRCoef[i], &(filter_state[i][0]), BLOCK_SIZE);
	}

  eqFrameSize = frameSize;
}

void eq_filter_frame(float32_t * inputF32, int16_t * outputI32, uint32_t frameSize)
{ 
	for (uint32_t i=0; i < frameSize/BLOCK_SIZE; i++)
	{
	  for (uint32_t j=0; j < NUM_FILTERS; j++)
	  {
	  	arm_fir_f32(&(filter_instance[j]), inputF32 + (i * BLOCK_SIZE), output, BLOCK_SIZE);
	  	for (uint32_t k=0; k < BLOCK_SIZE; k++)
	  	{
	  		outputI32[k + (i * BLOCK_SIZE)] += (int16_t) (((uint32_t) ((EQGains[selected_eq][j] * output[k]) + 32768)) >> 4);
	  	}
	  }
	}
}

void eq_filter_sample(int16_t inputI16, float32_t * outputF32)
{
	float32_t f_input = (float32_t) inputI16;
	float32_t f_output;
	for (uint32_t j=0; j < NUM_FILTERS; j++)
	{
		arm_fir_f32(&(filter_instance[j]), &f_input, &f_output, 1);
		*outputF32 += (EQGains[selected_eq][j] * f_output);
	}
}

void eq_set_frame_size(uint32_t frameSize)
{
	eqFrameSize = frameSize;
}

void eq_set_eq(uint8_t eq){
	selected_eq = eq;
}
